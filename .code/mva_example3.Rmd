---
title: "Multivariate analysis - Metric and Non-metric Multidimensional Scaling"
author: "Murray Logan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
    css: ../public/resources/ws_style.css
  pdf_document:
    df_print: default
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    latex_engine: xelatex
    number_sections: yes
    toc_depth: 2
  word_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    toc: yes
    toc_depth: 2
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
monofont: DejaVu Sans Mono
classoption: a4paper
bibliography: ../public/resources/references.bib
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE,cache.lazy = FALSE, tidy='styler')
```

# Preparations

Load the necessary libraries

```{r libraries, results='markdown', eval=TRUE}
library(tidyverse)  #for data wrangling etc
library(vegan)
library(ggvegan)
library(ggrepel)
library(GGally)
library(corrplot)
library(mvabund)
library(gllvm)
library(EcolUtils)
library(car)
library(glmmTMB)
library(scales)
```


# Scenario


# Read in the data

```{r readData, results='markdown', eval=TRUE}
macnally <- read.csv('../public/data/macnally_full.csv',strip.white=TRUE)
head(macnally)
macnally[1:5,1:5]
```


# PCoA

```{r PCoA1, results='markdown', eval=TRUE, hidden=TRUE, fig.width=6, fig.height=6, hidden=TRUE}
macnally.std <-
    macnally %>% dplyr::select(-HABITAT) %>%
    decostand(method="total",MARGIN=2)
macnally.std

macnally.dist = vegdist(macnally.std, method='bray')
macnally.capscale = capscale(macnally.dist~1, data=macnally$HABITAT)
macnally.capscale = capscale(macnally[,-1]~1, data=macnally$HABITAT)

summary(macnally.capscale, display=NULL)
plot(macnally.capscale)
autoplot(macnally.capscale, geom='text') + theme_bw()

```



# MetaMDS {.tabset .tabset-faded}

## MDS

```{r MDS1, results='markdown', eval=TRUE, hidden=TRUE, fig.width=6, fig.height=6, hidden=TRUE}
macnally.mds <- metaMDS(macnally[,-1], k=2,  plot=TRUE)
macnally.mds

#OR

macnally.std <- wisconsin(macnally[,c(-1)]^0.25)
macnally.dist <- vegdist(macnally.std,"bray")
macnally.mds1 <- metaMDS(macnally.std, k=2, plot=TRUE)
macnally.mds2 <- metaMDS(macnally.dist, k=2, plot=TRUE)

```

## Stress plot

```{r Stressplot, results='markdown', eval=TRUE, hidden=TRUE, fig.width=6, fig.height=6, hidden=TRUE}
stressplot(macnally.mds)
```

## Autoplot

```{r biplot1, results='markdown', eval=TRUE, hidden=TRUE, fig.width=6, fig.height=6, hidden=TRUE}
autoplot(macnally.mds) + theme_bw()
```

## Manually

```{r biplot2, results='markdown', eval=TRUE, hidden=TRUE, fig.width=6, fig.height=6, hidden=TRUE}
macnally.mds.scores <- macnally.mds %>%
    fortify() %>%
    full_join(macnally %>%
              rownames_to_column(var='Label'))

g <-
    ggplot(data = NULL, aes(y=NMDS2, x=NMDS1)) +
    geom_hline(yintercept=0, linetype='dotted') +
    geom_vline(xintercept=0, linetype='dotted') +
    geom_point(data=macnally.mds.scores %>% filter(Score=='sites'),
               aes(color=HABITAT)) +
    geom_text(data=macnally.mds.scores %>% filter(Score=='sites'),
              aes(label=Label, color=HABITAT), hjust=-0.2) 

g


g + ggforce::geom_mark_ellipse(data=macnally.mds.scores %>% filter(Score=='sites'),
                      aes(y=NMDS2, x=NMDS1, fill=HABITAT), expand=0) 
g <- g + ggforce::geom_mark_hull(data=macnally.mds.scores %>% filter(Score=='sites'),
                      aes(y=NMDS2, x=NMDS1, fill=HABITAT), concavity = 10) 

g + theme_bw()
```

## Envfit

```{r envfit, results='markdown', eval=TRUE, hidden=TRUE, fig.width=6, fig.height=6, hidden=TRUE}
Xmat <- model.matrix(~-1+HABITAT, data=macnally)
colnames(Xmat) <-gsub("HABITAT","",colnames(Xmat))
envfit <- envfit(macnally.mds, env=Xmat)
envfit

data.env.scores <- envfit %>% fortify()
g <- g + 
    geom_segment(data=data.env.scores,
                 aes(y=0, x=0, yend=NMDS2, xend=NMDS1),
                 arrow=arrow(length=unit(0.3,'lines')), color='blue') +
    geom_text(data=data.env.scores,
              aes(y=NMDS2*1.1, x=NMDS1*1.1, label=Label), color='blue')
g + theme_bw()

```

## Simper

Similarity percentage: decomposition of Bray-Curtis index
into contributions of each species to average between-group
dissim.

Pairwise displays most important species for each pair.
Caused by variation in species abundances and only partly
by differences among groups.
So driven by most abundant species.

```{r simper, results='markdown', eval=TRUE, hidden=TRUE, fig.width=6, fig.height=6, hidden=TRUE}
simper(macnally.std, macnally$HABITAT)
```

## Adonis (permutation anova)

```{r adonis, results='markdown', eval=TRUE, hidden=TRUE, fig.width=6, fig.height=6, hidden=TRUE}
macnally <- macnally %>% mutate(HABITAT = factor(HABITAT))
macnally.dist <- vegdist(macnally[,-1], 'bray')
macnally.adonis <- adonis2(macnally.dist ~ HABITAT, data=macnally)
macnally.adonis

EcolUtils::adonis.pair(macnally.dist, macnally$HABITAT)

```

## betadisper

betadisp = PERMDISP2

Analysis of multivariate homogeneity of group dispersions
(variances) - test for homogeneity of variance to test whether the
dispersions (variances) of one or more groups are differnt, the
distances of group memebers to the group centroid are subject to
ANOVA.

```{r betadisper, results='markdown', eval=TRUE, hidden=TRUE, fig.width=6, fig.height=6, hidden=TRUE}
macnally.disp <- betadisper(macnally.dist, macnally$HABITAT)
boxplot(macnally.disp)
plot(macnally.disp)
anova(macnally.disp)
permutest(macnally.disp, pairwise = TRUE)
TukeyHSD(macnally.disp)
```


Now with bias correction

Use the spatial median rather than the centroid (default)

If the median or centroid is calculated from the same data as then used to calculate dispersion,
dispersion will be biased downwards (less dispersion)

Adjust for small sample bias (default is false)
can also be biased by unequal sample sizes
good idea to correct for bias when sample sizes are small or uneven

```{r betadisper1, results='markdown', eval=TRUE, hidden=TRUE, fig.width=6, fig.height=6, hidden=TRUE}
macnally.disp <- betadisper(macnally.dist, macnally$HABITAT, type="median",bias.adjust = TRUE)
boxplot(macnally.disp)
plot(macnally.disp)
anova(macnally.disp)
permutest(macnally.disp, pairwise = TRUE)
TukeyHSD(macnally.disp)
```

# References
