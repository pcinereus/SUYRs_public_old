---
title: "Bayesian GLM Part5"
author: "Murray Logan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
    css: ../resources/ws_style.css
  pdf_document:
    df_print: default
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    latex_engine: xelatex
    number_sections: yes
    toc_depth: 2
  word_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    toc: yes
    toc_depth: 2
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
monofont: DejaVu Sans Mono
classoption: a4paper
bibliography: ../resources/references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE,cache.lazy = FALSE, tidy='styler')
```

# Preparations

Load the necessary libraries

```{r libraries, results='markdown', eval=TRUE}
library(tidyverse)  #for data wrangling etc
library(rstanarm)   #for fitting models in STAN
library(cmdstanr)   #for cmdstan
library(brms)       #for fitting models in STAN
library(standist)   #for exploring distributions
library(HDInterval) #for HPD intervals
library(posterior)  #for posterior draws
library(coda)       #for diagnostics
library(ggmcmc)     #for MCMC diagnostics
library(bayesplot)  #for diagnostics
library(rstan)      #for interfacing with STAN
library(DHARMa)     #for residual diagnostics
library(emmeans)    #for marginal means etc
library(broom)      #for tidying outputs
library(broom.mixed)#for summarising models
library(tidybayes)  #for more tidying outputs
library(ggeffects)  #for partial plots
library(tidyverse)  #for data wrangling etc
library(patchwork)  #for multi-panel figures
library(ggridges)   #for ridge plots
library(bayestestR) #for ROPE
library(see)        #for some plots
source('helperFunctions.R')
```


# Scenario

Here is a modified example from @Quinn-2002-2002. Day and Quinn
(1989) described an experiment that examined how rock surface type
affected the recruitment of barnacles to a rocky shore. The experiment
had a single factor, surface type, with 4 treatments or levels: algal
species 1 (ALG1), algal species 2 (ALG2), naturally bare surfaces (NB)
and artificially scraped bare surfaces (S). There were 5 replicate plots
for each surface type and the response (dependent) variable was the
number of newly recruited barnacles on each plot after 4 weeks.

![Six-plated barnacle](../resources/barnacles.jpg){width="224" height="308"}

Format of day.csv data files

TREAT   BARNACLE
------- ----------
ALG1    27
..      ..
ALG2    24
..      ..
NB      9
..      ..
S       12
..      ..

-------------- ----------------------------------------------------------------------------------------------------------------------------------------------
**TREAT**      Categorical listing of surface types. ALG1 = algal species 1, ALG2 = algal species 2, NB = naturally bare surface, S = scraped bare surface.
**BARNACLE**   The number of newly recruited barnacles on each plot after 4 weeks.
-------------- ----------------------------------------------------------------------------------------------------------------------------------------------

# Read in the data

```{r readData, results='markdown', eval=TRUE}
day <- read_csv('../data/day.csv', trim_ws = TRUE)
day %>% glimpse()
```

Start by declaring the categorical variables as factor.


Model formula:
$$
\begin{align}
y_i &\sim{} \mathcal{Pois}(\lambda_i)\\
ln(\mu_i) &= \boldsymbol{\beta} \bf{X_i}\\
\beta_0 &\sim{} \mathcal{N}(3.1, 1)\\
\beta_{1,2,3} &\sim{} \mathcal{N}(0,1)\\
\end{align}
$$

where $\boldsymbol{\beta}$ is a vector of effects parameters and $\bf{X}$ is a model matrix representing the intercept and treatment contrasts for the effects of Treatment on barnacle recruitment.

# Exploratory data analysis {.tabset .tabset-faded}


# Fit the model {.tabset .tabset-faded}


**Conclusions:**

- we see that the range of predictions is fairly wide (ranging from 0 to very high)

### Defining priors {.tabset .tabset-pills}

The following link provides some guidance about defining priors.
[https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations]

When defining our own priors, we typically do not want them to be scaled.

If we wanted to define our own priors that were less vague, yet still not likely
to bias the outcomes, we could try the following priors (mainly plucked out of
thin air):

- $\beta_0$: normal centred at 3 with a standard deviation of 10
  - mean of 3: since `mean(log(day$BARNACLE))`
  - sd of 1: since `sd(log(day$BARNACLE))`
- $\beta_1$: normal centred at 0 with a standard deviation of 6
  - sd of 1: since: `sd(log(day$BARNACLE))/apply(model.matrix(~TREAT, data = day), 2, sd)`
```{r, echo = FALSE, eval = FALSE}
day %>%
    group_by(TREAT) %>%
    summarise(mean(log(BARNACLE)),
              sd(log(BARNACLE)))

model.matrix(~TREAT, data = day)
apply(model.matrix(~TREAT, data = day), 2, sd)
sd(log(day$BARNACLE))/apply(model.matrix(~TREAT, data = day), 2, sd)

## day %>%
##     group_by(TREAT) %>%
##     summarise(BARNACLE = sample(log(BARNACLE), 1000, replace = TRUE),
##               R = 1:1000) %>%
##     ungroup() %>%
##     group_by(R) %>%
##     summarise(D = diff(BARNACLE), Comp = 1:3) %>%
##     ungroup() %>%
##     group_by(Comp) %>%
##     summarise(sd(D))
```

I will also overlay the raw data for comparison.


<div>

#### ggpredict


#### ggemmeans


#### conditional_effects


</div>


### Plotting prior and posterior


### Exploring the stan code


</div>

# MCMC sampling diagnostics {.tabset .tabset-faded}



# Model validation {.tabset .tabset-faded}



# Partial effects plots {.tabset .tabset-faded}


# Model investigation {.tabset .tabset-faded}


# Further investigations 


## Post-hoc test (Tukey's){.tabset .tabset-faded}



## Planned contrasts{.tabset .tabset-faded}

Define your own

Compare:

a) ALG1 vs ALG2
b) NB vs S
c) average of ALG1+ALG2 vs NB+S


# Summary Figure {.tabset .tabset-faded}


# References
